steps:
  - name: fetch
    image: alpine/git
    commands:
      - git fetch --tags

  - name: prettier
    image: node:24.12.0-alpine3.22
    commands:
      - apk add make
      - npm ci
      - make npm prettier-test
      - make sha
      - make typecheck
      - make test-ui

  - name: lint
    image: golangci/golangci-lint:v2.8.0
    commands:
      - make lint

  - name: test
    image: golang:1.24.0-alpine3.21
    commands:
      - apk add make git exiftool ffmpeg gcc g++
      - make test

  - name: build-push-rgallery
    image: woodpeckerci/plugin-docker-buildx
    settings:
      dockerfile: cmd/rgallery/Dockerfile
      platforms:
        - linux/arm64
        - linux/amd64
      repo: robbymilo/rgallery
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      tags:
        - ${CI_COMMIT_SHA}
        - ${CI_COMMIT_TAG}
        - latest
    depends_on:
      - test
      - lint
      - fetch

  - name: build-push-rgallery-resize
    image: woodpeckerci/plugin-docker-buildx
    settings:
      dockerfile: cmd/rgallery-resize/Dockerfile
      platforms:
        - linux/arm64
        - linux/amd64
      repo: robbymilo/rgallery
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      tags:
        - resize-${CI_COMMIT_SHA}
        - resize-${CI_COMMIT_TAG}
        - resize-latest
    depends_on:
      - test
      - lint
      - fetch

  - name: build-push-rgallery-geo
    image: woodpeckerci/plugin-docker-buildx
    settings:
      dockerfile: cmd/rgallery-geo/Dockerfile
      platforms:
        - linux/arm64
        - linux/amd64
      repo: robbymilo/rgallery
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      tags:
        - geo-${CI_COMMIT_SHA}
        - geo-${CI_COMMIT_TAG}
        - geo-latest
    depends_on:
      - test
      - lint
      - fetch

  - name: build-frontend
    image: node:24.12.0-alpine3.22
    commands:
      - apk add make
      - make npm assets
    depends_on:
      - prettier
      - lint
      - test

  - name: build-binaries
    image: golang:1.24.0-bookworm
    commands:
      - apt-get update && apt-get install -y make build-essential git
      - make build TARGETOS=linux TARGETARCH=amd64
      - make build TARGETOS=linux TARGETARCH=arm64
      - make build TARGETOS=darwin TARGETARCH=arm64
    depends_on:
      - build-frontend

  - name: publish-release
    image: plugins/github-release
    settings:
      api_key:
        from_secret: github_token
      files: bin/*
      title: ${CI_COMMIT_TAG}
    depends_on:
      - build-binaries

when:
  event:
    - tag
